<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifica√ß√µes de Anivers√°rio - WhatsApp API</title>
    <style>
        /* Manter todos os estilos anteriores e adicionar: */
        .api-config {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .status-connected {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-disconnected {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .api-test-area {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéâ Notifica√ß√µes de Anivers√°rio</h1>
        <p class="description">Envie automaticamente mensagens de anivers√°rio para o grupo do WhatsApp</p>
        
        <div id="birthdays-container">
            <!-- Aniversariantes do dia ser√£o inseridos aqui -->
        </div>
        
        <!-- Nova se√ß√£o de configura√ß√£o da API -->
        <div class="config-section">
            <h3>Configura√ß√µes da API WhatsApp</h3>
            
            <div class="api-config">
                <h4>Configura√ß√£o de Conex√£o</h4>
                
                <div class="form-group">
                    <label for="apiProvider">Provedor da API:</label>
                    <select id="apiProvider" class="form-control">
                        <option value="whatsapp-business">WhatsApp Business API</option>
                        <option value="twilio">Twilio</option>
                        <option value="apizap">APIZap</option>
                        <option value="custom">Customizada</option>
                    </select>
                </div>
                
                <div id="whatsapp-business-config" class="api-config-section">
                    <div class="form-group">
                        <label for="phoneNumberId">Phone Number ID:</label>
                        <input type="text" id="phoneNumberId" class="form-control" placeholder="1234567890">
                    </div>
                    
                    <div class="form-group">
                        <label for="accessToken">Access Token:</label>
                        <input type="password" id="accessToken" class="form-control" placeholder="Seu token de acesso">
                    </div>
                </div>
                
                <div id="twilio-config" class="api-config-section" style="display: none;">
                    <div class="form-group">
                        <label for="accountSid">Account SID:</label>
                        <input type="text" id="accountSid" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="twilioAuthToken">Auth Token:</label>
                        <input type="password" id="twilioAuthToken" class="form-control">
                    </div>
                </div>
                
                <div id="apizap-config" class="api-config-section" style="display: none;">
                    <div class="form-group">
                        <label for="apizapKey">API Key:</label>
                        <input type="password" id="apizapKey" class="form-control">
                    </div>
                </div>
                
                <div id="custom-config" class="api-config-section" style="display: none;">
                    <div class="form-group">
                        <label for="customEndpoint">Endpoint da API:</label>
                        <input type="text" id="customEndpoint" class="form-control" placeholder="https://api.exemplo.com/send">
                    </div>
                    
                    <div class="form-group">
                        <label for="customHeaders">Headers (JSON):</label>
                        <textarea id="customHeaders" class="form-control" rows="3" placeholder='{"Authorization": "Bearer token", "Content-Type": "application/json"}'></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="groupId">ID do Grupo:</label>
                    <input type="text" id="groupId" class="form-control" placeholder="ID do grupo WhatsApp">
                    <small style="color: #666;">Para WhatsApp Business API, use o ID do grupo. Para outros servi√ßos, consulte a documenta√ß√£o.</small>
                </div>
                
                <div id="apiStatus" class="api-status status-disconnected">
                    üî¥ API n√£o configurada
                </div>
                
                <div class="api-test-area">
                    <button class="btn btn-test" onclick="testAPIConnection()">Testar Conex√£o API</button>
                    <button class="btn btn-send" onclick="sendTestMessage()">Enviar Mensagem de Teste</button>
                </div>
            </div>
            
            <div class="auto-notification">
                <h4>Notifica√ß√£o Autom√°tica</h4>
                <p>Ative para enviar automaticamente mensagens de anivers√°rio para o grupo do WhatsApp</p>
                
                <div class="toggle-label">
                    <label for="autoNotification">Notifica√ß√£o autom√°tica:</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoNotification">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div id="autoSendStatus" class="auto-send-status" style="display: none;">
                    <p><span class="status-indicator status-active"></span> <strong>Notifica√ß√£o autom√°tica ativa</strong></p>
                    <p>As mensagens ser√£o enviadas automaticamente √†s 9h para os aniversariantes do dia.</p>
                </div>
                
                <div class="form-group">
                    <label for="customMessage">Mensagem Personalizada</label>
                    <textarea id="customMessage" class="form-control" rows="3" placeholder="Personalize a mensagem que ser√° enviada..."></textarea>
                    <small style="color: #666;">Use {nome} para incluir o nome do aniversariante</small>
                </div>
                
                <div class="birthday-actions">
                    <button class="btn btn-test" onclick="testNotification()">Testar Notifica√ß√£o</button>
                    <button class="btn btn-send" onclick="sendManualNotification()" id="sendManualBtn">
                        <span>üì§</span> Enviar Agora
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">
        Mensagem copiada para a √°rea de transfer√™ncia!
    </div>

    <script>
        // Configura√ß√µes da API
        let apiConfig = {
            provider: 'whatsapp-business',
            phoneNumberId: '',
            accessToken: '',
            accountSid: '',
            twilioAuthToken: '',
            apizapKey: '',
            customEndpoint: '',
            customHeaders: '{}',
            groupId: '',
            isConfigured: false
        };

        // Carregar configura√ß√µes da API
        function loadAPIConfig() {
            const savedConfig = localStorage.getItem('whatsappAPIConfig');
            if (savedConfig) {
                apiConfig = { ...apiConfig, ...JSON.parse(savedConfig) };
                updateAPIConfigUI();
                checkAPIStatus();
            }
        }

        // Atualizar UI da configura√ß√£o da API
        function updateAPIConfigUI() {
            document.getElementById('apiProvider').value = apiConfig.provider;
            document.getElementById('phoneNumberId').value = apiConfig.phoneNumberId;
            document.getElementById('accessToken').value = apiConfig.accessToken;
            document.getElementById('accountSid').value = apiConfig.accountSid;
            document.getElementById('twilioAuthToken').value = apiConfig.twilioAuthToken;
            document.getElementById('apizapKey').value = apiConfig.apizapKey;
            document.getElementById('customEndpoint').value = apiConfig.customEndpoint;
            document.getElementById('customHeaders').value = apiConfig.customHeaders;
            document.getElementById('groupId').value = apiConfig.groupId;
            
            // Mostrar/ocultar se√ß√µes baseadas no provedor
            document.querySelectorAll('.api-config-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(`${apiConfig.provider}-config`).style.display = 'block';
        }

        // Salvar configura√ß√µes da API
        function saveAPIConfig() {
            apiConfig.provider = document.getElementById('apiProvider').value;
            apiConfig.phoneNumberId = document.getElementById('phoneNumberId').value;
            apiConfig.accessToken = document.getElementById('accessToken').value;
            apiConfig.accountSid = document.getElementById('accountSid').value;
            apiConfig.twilioAuthToken = document.getElementById('twilioAuthToken').value;
            apiConfig.apizapKey = document.getElementById('apizapKey').value;
            apiConfig.customEndpoint = document.getElementById('customEndpoint').value;
            apiConfig.customHeaders = document.getElementById('customHeaders').value;
            apiConfig.groupId = document.getElementById('groupId').value;
            
            localStorage.setItem('whatsappAPIConfig', JSON.stringify(apiConfig));
            checkAPIStatus();
            showNotification('Configura√ß√µes da API salvas!');
        }

        // Verificar status da API
        function checkAPIStatus() {
            const statusElement = document.getElementById('apiStatus');
            const hasRequiredConfig = (
                apiConfig.groupId && 
                (
                    (apiConfig.provider === 'whatsapp-business' && apiConfig.phoneNumberId && apiConfig.accessToken) ||
                    (apiConfig.provider === 'twilio' && apiConfig.accountSid && apiConfig.twilioAuthToken) ||
                    (apiConfig.provider === 'apizap' && apiConfig.apizapKey) ||
                    (apiConfig.provider === 'custom' && apiConfig.customEndpoint)
                )
            );
            
            if (hasRequiredConfig) {
                statusElement.className = 'api-status status-connected';
                statusElement.innerHTML = 'üü¢ API Configurada';
                apiConfig.isConfigured = true;
            } else {
                statusElement.className = 'api-status status-disconnected';
                statusElement.innerHTML = 'üî¥ API n√£o configurada';
                apiConfig.isConfigured = false;
            }
        }

        // Enviar mensagem via API
        async function sendViaAPI(message) {
            if (!apiConfig.isConfigured) {
                throw new Error('API n√£o configurada');
            }

            switch (apiConfig.provider) {
                case 'whatsapp-business':
                    return await sendViaWhatsAppBusiness(message);
                case 'twilio':
                    return await sendViaTwilio(message);
                case 'apizap':
                    return await sendViaAPIZap(message);
                case 'custom':
                    return await sendViaCustomAPI(message);
                default:
                    throw new Error('Provedor n√£o suportado');
            }
        }

        // Implementa√ß√£o para WhatsApp Business API
        async function sendViaWhatsAppBusiness(message) {
            try {
                const response = await fetch(`https://graph.facebook.com/v17.0/${apiConfig.phoneNumberId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiConfig.accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        messaging_product: "whatsapp",
                        to: apiConfig.groupId,
                        type: "text",
                        text: {
                            body: message
                        }
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }
                
                return { success: true, data };
            } catch (error) {
                console.error('Erro WhatsApp Business API:', error);
                return { success: false, error: error.message };
            }
        }

        // Implementa√ß√£o para Twilio
        async function sendViaTwilio(message) {
            try {
                // Nota: Twilio requer chamada server-side por quest√µes de seguran√ßa
                // Esta √© uma implementa√ß√£o simplificada
                const response = await fetch('/api/send-whatsapp', { // Seu endpoint backend
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        provider: 'twilio',
                        accountSid: apiConfig.accountSid,
                        authToken: apiConfig.twilioAuthToken,
                        to: apiConfig.groupId,
                        message: message
                    })
                });

                return await response.json();
            } catch (error) {
                console.error('Erro Twilio:', error);
                return { success: false, error: error.message };
            }
        }

        // Implementa√ß√£o para APIZap
        async function sendViaAPIZap(message) {
            try {
                const response = await fetch('https://api.apizap.com/messages/send', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiConfig.apizapKey}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        number: apiConfig.groupId,
                        message: message,
                        type: 'group'
                    })
                });

                const data = await response.json();
                return { success: data.success, data };
            } catch (error) {
                console.error('Erro APIZap:', error);
                return { success: false, error: error.message };
            }
        }

        // Implementa√ß√£o para API Customizada
        async function sendViaCustomAPI(message) {
            try {
                const headers = JSON.parse(apiConfig.customHeaders || '{}');
                
                const response = await fetch(apiConfig.customEndpoint, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        to: apiConfig.groupId,
                        message: message
                    })
                });

                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                console.error('Erro API Customizada:', error);
                return { success: false, error: error.message };
            }
        }

        // Testar conex√£o da API
        async function testAPIConnection() {
            if (!apiConfig.isConfigured) {
                showNotification('Configure a API primeiro', 'error');
                return;
            }

            const testBtn = document.querySelector('.btn-test');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '‚è≥ Testando...';
            testBtn.disabled = true;

            try {
                const result = await sendViaAPI('üîß Mensagem de teste do sistema de anivers√°rios');
                
                if (result.success) {
                    showNotification('‚úÖ Conex√£o com API estabelecida com sucesso!');
                } else {
                    showNotification(`‚ùå Erro na API: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        // Enviar mensagem de teste
        async function sendTestMessage() {
            if (!apiConfig.isConfigured) {
                showNotification('Configure a API primeiro', 'error');
                return;
            }

            const testBtn = document.querySelector('.btn-send');
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '‚è≥ Enviando...';
            testBtn.disabled = true;

            try {
                const result = await sendViaAPI('üéâ Esta √© uma mensagem de teste do sistema de notifica√ß√µes de anivers√°rio!');
                
                if (result.success) {
                    showNotification('‚úÖ Mensagem de teste enviada com sucesso!');
                } else {
                    showNotification(`‚ùå Erro ao enviar: ${result.error}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
            } finally {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadAPIConfig();
            
            // Event listeners
            document.getElementById('apiProvider').addEventListener('change', function() {
                apiConfig.provider = this.value;
                updateAPIConfigUI();
                saveAPIConfig();
            });
            
            // Salvar configura√ß√µes quando alteradas
            const apiInputs = document.querySelectorAll('#phoneNumberId, #accessToken, #accountSid, #twilioAuthToken, #apizapKey, #customEndpoint, #customHeaders, #groupId');
            apiInputs.forEach(input => {
                input.addEventListener('change', saveAPIConfig);
            });
        });

        // ... (manter o restante do c√≥digo anterior)
    </script>
</body>
</html>
